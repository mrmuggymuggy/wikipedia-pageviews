# https://taskfile.dev

version: '2'

tasks:

  default:
    cmds:
      - echo executed on $DOCKER_REGISTRY
    silent: true

  # build image with COMMIT and LATEST tag
  build:
    cmds:
      - docker build -t $DOCKER_REGISTRY/data/flux/$DOCKER_IMAGE:$COMMIT .
      - task: tag_push

  tag_push:
    cmds:
      - >
        {{if eq .KUBE_CONTEXT "minikube"}}eval $(minikube docker-env){{end}}
        {{$kube_context := .KUBE_CONTEXT}}
        {{range $t := .TAGS | trim | splitLines -}}
            docker tag $DOCKER_REGISTRY/data/flux/$DOCKER_IMAGE:$COMMIT {{$t}};
            {{if ne $kube_context "minikube"}}
            docker push {{$t}}
            {{end}}
        {{end}}
    vars:
      TAGS: |
        "$DOCKER_REGISTRY/data/flux/$DOCKER_IMAGE:latest"
